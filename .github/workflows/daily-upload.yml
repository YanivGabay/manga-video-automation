name: Daily Manga Video Upload

on:
  schedule:
    # Run daily at 10:00 UTC (adjust to your preferred time)
    - cron: '0 10 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  create-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4

      - name: Checkout cache repo
        uses: actions/checkout@v4
        with:
          repository: YanivGabay/manga-video-cache
          token: ${{ secrets.GH_TOKEN }}
          path: manga_cache

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create .env file
        run: |
          cat << EOF > .env
          OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
          YT_CLIENT_ID=${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET=${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN=${{ secrets.YT_REFRESH_TOKEN }}
          GH_TOKEN=${{ secrets.GH_TOKEN }}
          TRACKER_GIST_ID=${{ secrets.TRACKER_GIST_ID }}
          CHANNEL_DEFAULT_TAGS=manga,anime,shorts,recap
          EOF

      - name: Run automation
        run: |
          python -m scheduler.automation run

      - name: Push cache updates
        run: |
          cd manga_cache
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Update cache - $(date -u +%Y-%m-%d)"
          git push
        continue-on-error: true  # Don't fail if no changes

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            output/
            *.log
          retention-days: 7
